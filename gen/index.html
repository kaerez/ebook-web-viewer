import React, { useState, useEffect } from 'react';
import { Copy, FileText, Settings, Code, Layers, Layout, Eye, CheckSquare, Smartphone, Monitor, Share2, Image as ImageIcon, Zap, MousePointer, Palette, Box, Type, Volume2, Database, Sliders, Plus, Trash2, Edit2, X, List, Film, Youtube, Globe, Music, Link as LinkIcon, ExternalLink, RefreshCw, Move } from 'lucide-react';

// --- LAYOUT PRESETS (Exact definitions from ui.md) ---
const LAYOUT_PRESETS = {
    "1": {
        // Layout 1 is the base default, so it implies resetting overrides to base
    },
    "2": {
        currentPage: { vAlign: 'bottom', hAlign: 'center' },
        btnAutoplay: { hAlign: 'left' },
        btnSound: { hAlign: 'left' },
        btnExpand: { hAlign: 'right' },
        btnZoomIn: { hAlign: 'right' },
        btnZoomOut: { hAlign: 'right' },
        btnSearch: { hAlign: 'left' },
        btnBookmark: { hAlign: 'left' },
        btnToc: { hAlign: 'left' },
        btnThumbs: { hAlign: 'left' },
        btnShare: { hAlign: 'right' },
        btnPrint: { hAlign: 'right' },
        btnDownloadPages: { hAlign: 'right' },
        btnDownloadPdf: { hAlign: 'right' },
        btnSelect: { hAlign: 'right' }
    },
    "3": {
        menuTransparent: true,
        menu2Transparent: false,
        menu2OverBook: false,
        menu2Padding: 5,
        btnMargin: 5,
        currentPage: { vAlign: 'top', hAlign: 'center' },
        btnPrint: { vAlign: 'top', hAlign: 'right' },
        btnDownloadPdf: { vAlign: 'top', hAlign: 'right' },
        btnDownloadPages: { vAlign: 'top', hAlign: 'right' },
        btnThumbs: { vAlign: 'top', hAlign: 'left' },
        btnToc: { vAlign: 'top', hAlign: 'left' },
        btnBookmark: { vAlign: 'top', hAlign: 'left' },
        btnSearch: { vAlign: 'top', hAlign: 'left' },
        btnSelect: { vAlign: 'top', hAlign: 'right' },
        btnShare: { vAlign: 'top', hAlign: 'right' },
        btnAutoplay: { hAlign: 'right' },
        btnExpand: { hAlign: 'right' },
        btnZoomIn: { hAlign: 'right' },
        btnZoomOut: { hAlign: 'right' },
        btnSound: { hAlign: 'right' },
        menuPadding: 5
    },
    "4": {
        menu2Transparent: false,
        menu2OverBook: false,
        sideMenuOverMenu2: false,
        currentPage: { vAlign: 'top', hAlign: 'center' },
        btnAutoplay: { vAlign: 'top', hAlign: 'left' },
        btnSound: { vAlign: 'top', hAlign: 'left' },
        btnExpand: { vAlign: 'top', hAlign: 'right' },
        btnZoomIn: { vAlign: 'top', hAlign: 'right' },
        btnZoomOut: { vAlign: 'top', hAlign: 'right' },
        btnSearch: { vAlign: 'top', hAlign: 'left' },
        btnBookmark: { vAlign: 'top', hAlign: 'left' },
        btnToc: { vAlign: 'top', hAlign: 'left' },
        btnThumbs: { vAlign: 'top', hAlign: 'left' },
        btnShare: { vAlign: 'top', hAlign: 'right' },
        btnPrint: { vAlign: 'top', hAlign: 'right' },
        btnDownloadPages: { vAlign: 'top', hAlign: 'right' },
        btnDownloadPdf: { vAlign: 'top', hAlign: 'right' },
        btnSelect: { vAlign: 'top', hAlign: 'right' }
    }
};

// --- HELP DESCRIPTIONS ---
const tooltips = {
    // Source
    pdfUrl: "Url to the PDF file. You can use relative or absolute path.",
    licenseKey: "Your commercial license key for Real3D FlipBook.",
    name: "Project Name. Used for internal reference or specific download filenames.",
    pages: "Array of page objects (images/html). Use the Page Manager to edit.",
    tableOfContent: "Array of TOC items. Use the TOC Manager to edit.",
    assets: "Paths to static assets like sounds and preloader images.",
    pdfAutoLinks: "Automatically detect and create links from the PDF text.",
    disableAutoFetch: "Prevent automatic fetching of the next PDF chunks.",
    loadAllPages: "Load all pages on start. Good for small books, bad for memory on large ones.",
    loadPagesF: "Number of pages to pre-load forward.",
    loadPagesB: "Number of pages to keep in memory backward.",
    
    // Appearance
    skin: "Predefined color schemes: 'light', 'dark', or 'gradient'.",
    layout: "UI Layout preset (1-4). Changing this Auto-Sets other options.",
    skinColor: "Primary skin color (CSS).",
    skinBackground: "Secondary skin color (CSS).",
    backgroundColor: "Background color of the book container (CSS value, e.g., #333 or rgba(0,0,0,0.5)).",
    backgroundImage: "URL for a background image.",
    backgroundPattern: "URL for a repeating background pattern.",
    backgroundTransparent: "Make the book background transparent.",
    logoImg: "URL for a logo image to display over the book.",
    logoUrl: "URL to open when the logo is clicked.",
    logoCSS: "CSS positioning for the logo (e.g., 'top: 10px; left: 10px;').",
    preloaderText: "Text to display while loading.",
    
    // View
    viewMode: "Animation mode: 'webgl' (realistic 3D), '3d' (CSS3D), '2d' (no skew), 'swipe' (horizontal scroll), or 'simple' (no animation).",
    rightToLeft: "Enable for RTL languages like Arabic or Hebrew. Book opens from left.",
    singlePageMode: "Forces single page view even on large screens.",
    pageFlipDuration: "Duration of the page turn animation in seconds.",
    startPage: "The page number to show immediately on load.",
    thumbSize: "Height of the thumbnails in the thumbnail menu (px).",
    responsiveView: "Enable responsive view adjustments.",
    responsiveViewRatio: "Ratio threshold for responsive view.",
    minPixelRatio: "Minimum pixel ratio (1-2) for rendering. 1.5 offers good balance of fps/quality.",
    
    // UI
    menuOverBook: "If true, the bottom menu floats over the book content instead of pushing it up.",
    menuFloating: "Makes the menu float with a margin/radius rather than spanning full width.",
    menuTransparent: "Make the bottom menu background transparent.",
    menuBackground: "CSS background for the bottom menu.",
    menuShadow: "CSS box-shadow for the bottom menu.",
    menuPadding: "Padding for the bottom menu (px).",
    menu2OverBook: "Top menu floats over book.",
    menu2Transparent: "Make the top menu background transparent.",
    menu2Padding: "Padding for the top menu (px).",
    sideMenuPosition: "Position of the side menu ('left' or 'right').",
    btnOrder: "Array defining the order of buttons in the toolbar.",
    
    // Styling
    btnColor: "Color of the toolbar button icons (CSS value).",
    btnBackground: "Background color of the toolbar buttons.",
    btnRadius: "Border radius of toolbar buttons (px).",
    btnSize: "Size of toolbar icons (px).",
    btnMargin: "Margin between toolbar buttons (px).",
    sideBtnColor: "Color of the side navigation arrows.",
    sideBtnSize: "Size of the side navigation arrows (px).",
    
    // Behavior
    touchSwipeEnabled: "Enable swiping on touch devices to turn pages.",
    flipSound: "Play sound effect when turning pages.",
    backgroundMusic: "URL to background music file (mp3).",
    autoplayOnStart: "Start turning pages automatically when the book loads.",
    zoomStep: "Factor to zoom in/out on each click.",
    zoomMax2: "Second level max zoom factor.",
    zoomReset: "Reset zoom level when changing pages.",
    deeplinkingEnabled: "Enable URL hash changes (e.g., #page1) for deep linking.",
    rightClickEnabled: "Allow right-click context menu.",
    pageDragDisabled: "Disable dragging pages with mouse.",
    pageClickAreaWdith: "Width of the edge area that triggers page turn (e.g., '10%').",
    wheelDisabledNotFullscreen: "Disable mouse wheel zoom unless in fullscreen.",
    arrowsDisabledNotFullscreen: "Disable keyboard arrows unless in fullscreen.",
    contentOnStart: "Open Table of Contents sidebar on load.",
    thumbnailsOnStart: "Open Thumbnails sidebar on load.",
    searchOnStart: "Open Search sidebar on load.",
    
    // WebGL
    pan: "Camera panoramic angle (horizontal rotation) in degrees.",
    tilt: "Camera tilt angle (vertical rotation) in degrees.",
    lights: "Enable dynamic lighting in WebGL mode.",
    webglShadows: "Enable realistic shadows in WebGL mode (performance intensive).",
    pageHardness: "How much the pages bend. Lower values = more flexible paper.",
    pageTextureSize: "Resolution of page textures (e.g., 2048). Higher = sharper but more memory.",
    pageTextureSizeSmall: "Texture size for small screens/thumbnails.",
    disableImageResize: "Disable automatic resizing of images to powers of 2 (needed for some filtering).",
    antialias: "Enable WebGL antialiasing (smoother edges, higher cost).",
    
    // Advanced
    rangeChunkSize: "Size of PDF chunks to fetch (in KB). Tuning this can improve load perf.",
    disableStream: "Disable PDF streaming (fetches full file).",
    disableRange: "Disable range requests.",
    pdfBrowserViewerIfMobile: "Open native PDF viewer on mobile instead of Flipbook.",
    printMenu: "Enable the Print menu options.",
    linkColor: "Color of links overlay on pages.",
    cover: "Show the first page as a cover (single page).",
    backCover: "Show the last page as a back cover.",
    noteTypes: "Configuration for annotation note types (User, Group, Admin).",
    minimumAndroidVersion: "Minimum Android version required to run.",
    pageRangeStart: "Start page index for PDF rendering limitation.",
    pageRangeEnd: "End page index for PDF rendering limitation.",
    
    // Download Buttons
    btnDownloadPagesUrl: "URL to the zip file containing all pages.",
    btnDownloadPdfUrl: "URL to the PDF file for download.",
    btnDownloadPdfOpenInNewWindow: "Open PDF download in a new window."
};

// --- DEFAULT OPTIONS (FULL - Corresponds to Layout 1 Base) ---
const defaultOptions = {
    name: "My Flipbook",
    pages: [],
    tableOfContent: [],
    
    // SOURCE
    pdfUrl: "books/guide.pdf",
    pdfBrowserViewerIfMobile: false,
    pdfBrowserViewerIfIE: false,
    pdfBrowserViewerFullscreen: true,
    pdfBrowserViewerFullscreenTarget: "_blank",
    rangeChunkSize: 64,
    disableRange: false,
    disableStream: true,
    disableAutoFetch: true,
    pdfAutoLinks: false,
    htmlLayer: true,
    loadAllPages: false,
    loadPagesF: 2,
    loadPagesB: 1,
    pageRangeStart: null, 
    pageRangeEnd: null,
    
    // APPEARANCE
    skin: "light",
    layout: "1",
    skinColor: '',
    skinBackground: '',
    backgroundColor: "rgb(81, 85, 88)",
    backgroundImage: "",
    backgroundPattern: "",
    backgroundTransparent: false,
    logoImg: '', logoUrl: '', logoCSS: 'position:absolute;', logoHideOnMobile: false,
    preloaderText: '',
    fillPreloader: { enabled: false, imgEmpty: "images/logo_light.png", imgFull: "images/logo_dark.png" },
    
    // VIEW
    viewMode: 'webgl',
    rightToLeft: false,
    startPage: 0,
    pageNumberOffset: 0,
    singlePageMode: false,
    singlePageModeIfMobile: false,
    responsiveView: true,
    responsiveViewRatio: 1,
    responsiveViewTreshold: 768,
    minPixelRatio: 1,
    pageFlipDuration: 1,
    thumbSize: 130,
    
    // UI
    menuOverBook: false,
    menuFloating: false,
    menuBackground: '',
    menuShadow: '',
    menuMargin: 0,
    menuPadding: 0,
    menuTransparent: false,
    menu2OverBook: true,
    menu2Floating: false,
    menu2Background: '',
    menu2Shadow: '',
    menu2Margin: 0,
    menu2Padding: 0,
    menu2Transparent: true,
    hideMenu: false,
    sideMenuOverBook: true,
    sideMenuOverMenu: false,
    sideMenuOverMenu2: true,
    sideMenuPosition: 'left',
    
    // STYLES
    btnColor: '', btnBackground: 'none', btnSize: 14, btnRadius: 2, btnMargin: 2, btnPaddingV: 10, btnPaddingH: 10,
    btnShadow: '', btnTextShadow: '', btnBorder: '', btnColorHover: "", btnBackgroundHover: '',
    
    sideNavigationButtons: true,
    sideBtnColor: '#FFF', sideBtnBackground: '#00000033', sideBtnSize: 30, sideBtnRadius: 0, sideBtnMargin: 0,
    sideBtnPaddingV: 5, sideBtnPaddingH: 0, sideBtnShadow: '', sideBtnTextShadow: '', sideBtnBorder: '',
    sideBtnColorHover: "#FFF", sideBtnBackgroundHover: '#00000066',
    
    floatingBtnColor: "#EEE", floatingBtnColorHover: "", floatingBtnBackground: "#00000044", floatingBtnBackgroundHover: '',
    
    btnOrder: [
        'currentPage', 'btnFirst', 'btnPrev', 'btnNext', 'btnLast', 'btnZoomIn', 
        'btnZoomOut', 'btnRotateLeft', 'btnRotateRight', 'btnAutoplay', 'btnSearch', 
        'btnSelect', 'btnBookmark', 'btnNotes', 'btnToc', 'btnThumbs', 'btnShare', 
        'btnPrint', 'btnDownloadPages', 'btnDownloadPdf', 'btnSound', 'btnExpand', 'btnClose'
    ],

    // BUTTONS (Base settings, effectively Layout 1 defaults)
    currentPage: { enabled: true, title: "Current page", vAlign: 'top', hAlign: 'left' },
    btnFirst: { enabled: false, title: "First page", iconFA: "flipbook-icon-angle-double-left", iconM: "flipbook-icon-first_page", vAlign: 'top', hAlign: 'left' },
    btnPrev: { enabled: true, title: "Previous page", iconFA: "flipbook-icon-angle-left", iconM: "flipbook-icon-keyboard_arrow_left", vAlign: 'top', hAlign: 'left' },
    btnNext: { enabled: true, title: "Next page", iconFA: "flipbook-icon-angle-right", iconM: "flipbook-icon-keyboard_arrow_right", vAlign: 'top', hAlign: 'left' },
    btnLast: { enabled: false, title: "Last page", iconFA: "flipbook-icon-angle-double-right", iconM: "flipbook-icon-last_page", vAlign: 'top', hAlign: 'left' },
    btnZoomIn: { enabled: true, title: "Zoom in", iconFA: "flipbook-icon-plus", iconM: "flipbook-icon-add", vAlign: 'top', hAlign: 'left' },
    btnZoomOut: { enabled: true, title: "Zoom out", iconFA: "flipbook-icon-minus", iconM: "flipbook-icon-remove1", vAlign: 'top', hAlign: 'left' },
    btnRotateLeft: { enabled: false, title: "Rotate left", iconFA: "flipbook-icon--undo", vAlign: 'top', hAlign: 'left' },
    btnRotateRight: { enabled: false, title: "Rotate right", iconFA: "flipbook-icon--redo", vAlign: 'top', hAlign: 'left' },
    btnAutoplay: { enabled: true, title: "Autoplay", iconFA: "flipbook-icon-play", iconM: "flipbook-icon-play_arrow", vAlign: 'top', hAlign: 'left' },
    btnSearch: { enabled: false, title: "Search", iconFA: "flipbook-icon-search", iconM: "flipbook-icon-search1", vAlign: 'top', hAlign: 'left' },
    btnSelect: { enabled: true, title: "Select tool", iconFA: "flipbook-icon-i-cursor", iconM: "flipbook-icon-text_format", vAlign: 'top', hAlign: 'left' },
    btnBookmark: { enabled: true, title: "Bookmark", iconFA: "flipbook-icon-bookmark", iconM: "flipbook-icon-bookmark1", vAlign: 'top', hAlign: 'left' },
    btnNotes: { enabled: false, title: "Notes", iconFA: "flipbook-icon-comment", iconM: "flipbook-icon-chat_bubble", vAlign: 'top', hAlign: 'left' },
    btnToc: { enabled: true, title: "Table of Contents", iconFA: "flipbook-icon-list-ol", iconM: "flipbook-icon-toc", vAlign: 'top', hAlign: 'left' },
    btnThumbs: { enabled: true, title: "Pages", iconFA: "flipbook-icon-th-large", iconM: "flipbook-icon-view_module", vAlign: 'top', hAlign: 'left' },
    btnShare: { enabled: true, title: "Share", iconFA: "flipbook-icon-share-alt", iconM: "flipbook-icon-share1", hideOnMobile: true, vAlign: 'top', hAlign: 'left' },
    btnPrint: { enabled: true, title: "Print", iconFA: "flipbook-icon-print", iconM: "flipbook-icon-local_printshop", hideOnMobile: true, vAlign: 'top', hAlign: 'left' },
    btnDownloadPages: { enabled: true, title: "Download pages", iconFA: "flipbook-icon-download", iconM: "flipbook-icon-file_download", url: "images/pages.zip", name: "allPages.zip", vAlign: 'top', hAlign: 'left' },
    btnDownloadPdf: { forceDownload: false, enabled: true, title: "Download PDF", iconFA: "flipbook-icon-file", iconM: "flipbook-icon-picture_as_pdf", url: null, openInNewWindow: true, name: "allPages.pdf", vAlign: 'top', hAlign: 'left' },
    btnSound: { enabled: true, title: "Volume", iconFA: "flipbook-icon-volume-up", hideOnMobile: true, vAlign: 'top', hAlign: 'left' },
    btnExpand: { enabled: true, title: "Toggle fullscreen", iconFA: "flipbook-icon-expand", iconM: "flipbook-icon-fullscreen", vAlign: 'top', hAlign: 'left' },
    btnClose: { title: "Close", iconFA: "flipbook-icon-times", iconM: "flipbook-icon-clear", hAlign: 'right', vAlign: 'top', size: 20 },
    
    btnShareIfMobile: false, btnSoundIfMobile: false, btnPrintIfMobile: false,

    // BEHAVIOR
    sound: true, flipSound: true, backgroundMusic: false, autoplayOnStart: false, autoplayInterval: 3000, autoplayLoop: true,
    zoomMin: .95, zoomMax2: null, zoomSize: null, zoomStep: 2, zoomTime: 300, zoomReset: false, zoomResetTime: 300,
    doubleClickZoomDisabled: false, pageDragDisabled: false, pageClickAreaWdith: '10%',
    wheelDisabledNotFullscreen: false, arrowsDisabledNotFullscreen: false, arrowsAlwaysEnabledForNavigation: true, touchSwipeEnabled: true,
    deeplinkingEnabled: false, deeplinkingPrefix: '',
    contentOnStart: false, thumbnailsOnStart: false, searchOnStart: false,
    
    // LIGHTBOX
    lightBox: false, lightBoxOpened: false, lightBoxFullscreen: false, lightboxCloseOnClick: false, lightboxResetOnOpen: true,
    lightboxBackground: null, lightboxBackgroundColor: null, lightboxBackgroundPattern: null, lightboxBackgroundImage: null,
    lightboxStartPage: null, lightboxMarginV: '0', lightboxMarginH: '0', lightboxCSS: '', lightboxPreload: false,
    lightboxShowMenu: false, lightboxCloseOnBack: true,
    
    // WEBGL
    pan: 0, panMax: 10, panMax2: 2, panMin: -10, panMin2: -2,
    tilt: 0, tiltMax: 0, tiltMax2: 0, tiltMin: -20, tiltMin2: -5,
    rotateCameraOnMouseMove: false, rotateCameraOnMouseDrag: true,
    lights: true, lightColor: 0xFFFFFF, lightPositionX: 0, lightPositionZ: 1400, lightPositionY: 350, lightIntensity: .6,
    shadows: true, shadowMapSize: 1024, shadowOpacity: .2, shadowDistance: 0,
    pageRoughness: 1, pageMetalness: 0, pageHardness: 2, coverHardness: 2, pageSegmentsW: 10, pageSegmentsH: 1,
    pageMiddleShadowSize: 2, pageMiddleShadowColorL: "#999999", pageMiddleShadowColorR: "#777777",
    antialias: false, disableImageResize: true,
    pageTextureSize: 2048, pageTextureSizeSmall: 1500, thumbTextureSize: 300,
    
    // SOCIAL
    shareUrl: null, shareTitle: null, shareImage: null,
    whatsapp: { enabled: true }, twitter: { enabled: true }, facebook: { enabled: true }, pinterest: { enabled: true },
    email: { enabled: true }, linkedin: { enabled: true }, digg: { enabled: false }, reddit: { enabled: false },
    
    // ASSETS & ADVANCED
    assets: { preloader: "images/preloader.jpg", overlay: "images/overlay.png", flipMp3: "mp3/turnPage.mp3", spinner: "images/spinner.gif", backgroundMp3: "mp3/background.mp3" },
    strings: {
        print: "Print",
        printLeftPage: "Print left page",
        printRightPage: "Print right page",
        printCurrentPage: "Print current page",
        printAllPages: "Print all pages",
        download: "Download",
        downloadLeftPage: "Download left page",
        downloadRightPage: "Download right page",
        downloadCurrentPage: "Download current page",
        downloadAllPages: "Download all pages",
        bookmarks: "Bookmarks",
        bookmarkLeftPage: "Bookmark left page",
        bookmarkRightPage: "Bookmark right page",
        bookmarkCurrentPage: "Bookmark current page",
        search: "Search",
        findInDocument: "Find in document",
        pagesFoundContaining: "pages found containing",
        noMatches: "No matches",
        matchesFound: "matches found",
        page: "Page",
        matches: "matches",
        thumbnails: "Thumbnails",
        tableOfContent: "Table of Contents",
        share: "Share",
        notes: "Notes",
        pressEscToClose: "Press ESC to close",
        password: "Password",
        addNote: "Add note",
        typeInYourNote: "Type in your note..."
    },
    
    // MOBILE
    mobile: {
        pageTextureSize: 1500,
        pageTextureSizeSmall: 1024,
        pageSegmentsW: 5,
        shadows: false
    },
    googleAnalyticsTrackingCode: null, minimumAndroidVersion: 6, rightClickEnabled: true,
    pdfTextLayer: true, annotationLayer: true,
    printMenu: true, downloadMenu: true, cover: true, backCover: true,
    linkColor: 'rgba(0, 0, 0, 0)', linkColorHover: 'rgba(255, 255, 0, 1)', linkOpacity: 0.4, linkTarget: '_blank',
    
    noteTypes: [
        { id: 1, title: "User", color: "green", enabled: true },
        { id: 2, title: "Group", color: "yellow", enabled: true },
        { id: 3, title: "Admin", color: "blue", enabled: true },
    ]
};

// --- HELPER COMPONENTS ---

const HelpIcon = ({ text }) => (
  <div className="group relative inline-block ml-1 align-middle z-40">
    <svg viewBox="0 0 16 16" className="w-3 h-3 text-slate-400 cursor-help hover:text-blue-500 transition-colors" aria-hidden="true" focusable="false">
        <path d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zm0 12a5.5 5.5 0 110-11 5.5 5.5 0 010 11z" fill="currentColor" />
        <path d="M8.572 6.253H6.607v1h.965v3.812H6.397v1h3.35v-1H8.572V6.253zM8.49 4.032H7.235v1.255H8.49V4.032z" fill="currentColor" />
    </svg>
    <div className="invisible group-hover:visible absolute z-50 w-64 p-3 mt-1 text-xs leading-relaxed text-white bg-slate-800 rounded-lg shadow-xl right-0 bottom-full mb-2 pointer-events-none origin-bottom-right">
      {text || "No description available."}
      <div className="absolute right-1 -ml-1 top-full w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-800"></div>
    </div>
  </div>
);

// --- INPUT COMPONENTS ---

const FieldWrapper = ({ label, helpKey, isMobile, hasOverride, children }) => (
    <div className={`mb-3 relative ${isMobile && hasOverride ? 'border-l-2 border-purple-500 pl-3 -ml-3' : ''}`}>
        <div className="flex justify-between items-center mb-1">
             <label className={`block text-xs font-bold uppercase tracking-wide flex items-center ${isMobile ? 'text-purple-600 dark:text-purple-400' : 'text-slate-500'}`}>
                {label}
                {helpKey && <HelpIcon text={tooltips[helpKey]} />}
            </label>
            {isMobile && !hasOverride && <span className="text-[10px] text-slate-400 italic">Inherited</span>}
            {isMobile && hasOverride && <span className="text-[10px] text-purple-500 font-bold">Override Active</span>}
        </div>
        {children}
    </div>
);

const Toggle = ({ label, checked, onChange, helpKey, isMobile, hasOverride }) => (
  <div className={`flex items-center justify-between py-2 border-b border-slate-100 dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800/50 px-2 rounded -mx-2 transition-colors ${isMobile && hasOverride ? 'bg-purple-50 dark:bg-purple-900/10' : ''}`}>
    <span className={`text-sm flex items-center ${isMobile ? 'text-purple-700 dark:text-purple-300' : 'text-slate-700 dark:text-slate-300'}`}>
        {label}
        {helpKey && <HelpIcon text={tooltips[helpKey]} />}
    </span>
    <button
      onClick={() => onChange(!checked)}
      className={`relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none ${checked ? (isMobile ? 'bg-purple-600' : 'bg-blue-600') : 'bg-slate-300 dark:bg-slate-600'}`}
    >
      <span className={`pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${checked ? 'translate-x-4' : 'translate-x-0'}`} />
    </button>
  </div>
);

const TextInput = ({ label, value, onChange, placeholder, helpKey, isMobile, hasOverride }) => (
  <FieldWrapper label={label} helpKey={helpKey} isMobile={isMobile} hasOverride={hasOverride}>
    <input
      type="text"
      className={`block w-full rounded-md border text-sm p-2 shadow-sm focus:ring-1 
        ${isMobile 
            ? 'border-purple-300 dark:border-purple-700 bg-purple-50 dark:bg-purple-900/20 text-purple-900 dark:text-purple-100 focus:ring-purple-500 focus:border-purple-500' 
            : 'border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-blue-500 focus:border-blue-500'
        }`}
      placeholder={isMobile && !hasOverride ? "Inherited from Desktop" : placeholder}
      value={value === null || value === undefined ? '' : value}
      onChange={(e) => onChange(e.target.value)}
    />
  </FieldWrapper>
);

const NumberInput = ({ label, value, onChange, step = 1, helpKey, isMobile, hasOverride }) => (
    <FieldWrapper label={label} helpKey={helpKey} isMobile={isMobile} hasOverride={hasOverride}>
      <input
        type="number"
        step={step}
        className={`block w-full rounded-md border text-sm p-2 shadow-sm focus:ring-1 
            ${isMobile 
                ? 'border-purple-300 dark:border-purple-700 bg-purple-50 dark:bg-purple-900/20 text-purple-900 dark:text-purple-100 focus:ring-purple-500 focus:border-purple-500' 
                : 'border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-blue-500 focus:border-blue-500'
            }`}
        value={value === null || value === undefined ? '' : value}
        onChange={(e) => onChange(e.target.value === '' ? null : Number(e.target.value))}
      />
    </FieldWrapper>
);

const SelectInput = ({ label, value, onChange, options, helpKey, isMobile, hasOverride }) => (
  <FieldWrapper label={label} helpKey={helpKey} isMobile={isMobile} hasOverride={hasOverride}>
    <select
      value={value === undefined ? '' : value}
      onChange={(e) => onChange(e.target.value)}
      className={`block w-full rounded-md border text-sm p-2 shadow-sm focus:ring-1 
        ${isMobile 
            ? 'border-purple-300 dark:border-purple-700 bg-purple-50 dark:bg-purple-900/20 text-purple-900 dark:text-purple-100 focus:ring-purple-500 focus:border-purple-500' 
            : 'border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-blue-500 focus:border-blue-500'
        }`}
    >
      {isMobile && <option value="">(Inherit)</option>}
      {options.map(opt => (
        <option key={opt.value} value={opt.value}>{opt.label}</option>
      ))}
    </select>
  </FieldWrapper>
);

const JsonInput = ({ label, value, onChange, helpKey, isMobile }) => {
    const [error, setError] = useState(false);
    const handleChange = (e) => {
        try {
            const parsed = JSON.parse(e.target.value);
            onChange(parsed);
            setError(false);
        } catch (err) {
            setError(true);
        }
    };
    return (
        <div className="mb-3">
             <label className={`block text-xs font-bold uppercase tracking-wide flex justify-between items-center mb-1 ${isMobile ? 'text-purple-600' : 'text-slate-500'}`}>
                <span className="flex items-center">{label} {helpKey && <HelpIcon text={tooltips[helpKey]} />}</span>
                {error && <span className="text-red-500 lowercase font-normal">Invalid JSON</span>}
            </label>
            <textarea 
                className={`block w-full rounded-md border font-mono text-xs p-2 h-32 ${error ? 'border-red-500' : (isMobile ? 'border-purple-300 bg-purple-50 dark:bg-purple-900/20' : 'border-slate-300 bg-slate-50 dark:bg-slate-900 dark:border-slate-600')}`}
                defaultValue={JSON.stringify(value, null, 2)}
                onBlur={handleChange}
            />
        </div>
    )
}

const TabButton = ({ active, label, icon: Icon, onClick }) => (
    <button
        onClick={onClick}
        className={`flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${
            active 
            ? 'border-blue-600 text-blue-600 dark:text-blue-400' 
            : 'border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'
        }`}
    >
        <Icon size={16} />
        {label}
    </button>
);

const Section = ({ title, children, icon: Icon }) => (
    <div className="mb-8 border-b border-slate-100 dark:border-slate-700 pb-6 last:border-0 last:pb-0">
        <h3 className="text-sm font-bold uppercase text-blue-600 dark:text-blue-400 mb-4 flex items-center gap-2">
            {Icon && <Icon size={16} />}
            {title}
        </h3>
        {children}
    </div>
);

// --- MODAL COMPONENT ---
const Modal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-white dark:bg-slate-900 w-full h-full md:w-[95%] md:h-[95%] rounded-lg shadow-2xl overflow-hidden flex flex-col border border-slate-200 dark:border-slate-700" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-950">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100">{title}</h2>
                    <button onClick={onClose} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-colors">
                        <X size={20} />
                    </button>
                </div>
                <div className="flex-1 overflow-y-auto p-6">
                    {children}
                </div>
            </div>
        </div>
    );
};

// --- MAIN COMPONENT ---
const FlipBookGenerator = () => {
    const [config, setConfig] = useState({...defaultOptions});
    const [licenseKey, setLicenseKey] = useState('');
    const [framework, setFramework] = useState('vanilla');
    const [activeTab, setActiveTab] = useState('source');
    const [showCopyFeedback, setShowCopyFeedback] = useState(false);
    const [editScope, setEditScope] = useState('global'); // 'global' or 'mobile'
    
    // Page & TOC Management
    const [showPageManager, setShowPageManager] = useState(false);
    const [editingPage, setEditingPage] = useState(null);
    const [pageEditData, setPageEditData] = useState({});
    const [showTocManager, setShowTocManager] = useState(false);
    const [selectedBtn, setSelectedBtn] = useState('btnZoomIn');

    // UNIFIED UPDATE LOGIC
    // Reads value based on scope, writes to correct object
    const getValue = (key) => {
        if (editScope === 'mobile') {
            return config.mobile && config.mobile[key] !== undefined ? config.mobile[key] : config[key];
        }
        return config[key];
    };
    
    const hasMobileOverride = (key) => {
        return config.mobile && config.mobile[key] !== undefined;
    }

    const mergeObjects = (target, source) => {
        const output = { ...target };
        Object.keys(source).forEach(key => {
            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                output[key] = mergeObjects(target[key] || {}, source[key]);
            } else {
                output[key] = source[key];
            }
        });
        return output;
    };

    const update = (key, value) => {
        if (editScope === 'mobile') {
            setConfig(prev => ({
                ...prev,
                mobile: { ...prev.mobile, [key]: value }
            }));
        } else {
            // Check for Layout Change
            if (key === 'layout') {
                const preset = LAYOUT_PRESETS[value];
                if (preset) {
                    // Deep merge the preset into the config to update UI
                    let newConfig = { ...config, layout: value };
                    
                    // Reset to defaultOptions first then apply preset to ensure clean slate for UI
                    // Note: We only reset keys present in LAYOUT_PRESETS to avoid wiping user data
                    // Actually, safer to just apply preset over current config
                    newConfig = mergeObjects(newConfig, preset);
                    setConfig(newConfig);
                    return;
                }
            }
            setConfig(prev => ({ ...prev, [key]: value }));
        }
    };
    
    const updateString = (key, value) => {
        setConfig(prev => ({
            ...prev,
            strings: { ...prev.strings, [key]: value }
        }));
    };

    const toggleButton = (btnName) => {
        const currentVal = editScope === 'mobile' 
            ? (config.mobile[btnName] ? config.mobile[btnName].enabled : config[btnName].enabled)
            : config[btnName].enabled;
            
        const newVal = !currentVal;
        
        if (editScope === 'mobile') {
             setConfig(prev => ({
                ...prev,
                mobile: { 
                    ...prev.mobile, 
                    [btnName]: { ...(prev.mobile[btnName] || prev[btnName]), enabled: newVal } 
                }
            }));
        } else {
             setConfig(prev => ({ 
                 ...prev, 
                 [btnName]: { ...prev[btnName], enabled: newVal } 
             }));
        }
    };
    
    const toggleSocial = (socialName) => {
        // Social logic similar to buttons
        const currentVal = editScope === 'mobile'
             ? (config.mobile[socialName] ? config.mobile[socialName].enabled : config[socialName].enabled)
             : config[socialName].enabled;
        
         const newVal = !currentVal;
         
          if (editScope === 'mobile') {
             setConfig(prev => ({
                ...prev,
                mobile: { 
                    ...prev.mobile, 
                    [socialName]: { ...(prev.mobile[socialName] || prev[socialName]), enabled: newVal } 
                }
            }));
        } else {
            setConfig(prev => ({ ...prev, [socialName]: { ...prev[socialName], enabled: newVal } }));
        }
    };
    
    const updateButtonProp = (btnName, prop, value) => {
         if (editScope === 'mobile') {
             setConfig(prev => ({
                ...prev,
                mobile: { 
                    ...prev.mobile, 
                    [btnName]: { ...(prev.mobile[btnName] || prev[btnName]), [prop]: value } 
                }
            }));
         } else {
            setConfig(prev => ({
                ...prev,
                [btnName]: { ...prev[btnName], [prop]: value }
            }));
         }
    };
    
    // Page Manager Logic
    const addNewPage = () => {
        const newPage = { src: "", thumb: "", title: "", htmlContent: "", items: [] };
        setConfig(prev => ({ ...prev, pages: [...prev.pages, newPage] }));
        setEditingPage(config.pages.length); 
        setPageEditData(newPage);
    };
    const deletePage = (index) => setConfig(prev => ({ ...prev, pages: prev.pages.filter((_, i) => i !== index) }));
    const openEditPage = (index) => { setEditingPage(index); setPageEditData({ ...config.pages[index] }); };
    const savePageEdit = () => { const newPages = [...config.pages]; newPages[editingPage] = pageEditData; setConfig(prev => ({ ...prev, pages: newPages })); setEditingPage(null); };
    const updatePageData = (key, value) => setPageEditData(prev => ({ ...prev, [key]: value }));
    const addPageItem = () => { const newItem = { type: 'video', x: 0, y: 0, width: 200, height: 150, url: '' }; setPageEditData(prev => ({ ...prev, items: [...(prev.items || []), newItem] })); };
    const updatePageItem = (index, key, value) => { const newItems = [...(pageEditData.items || [])]; newItems[index] = { ...newItems[index], [key]: value }; setPageEditData(prev => ({ ...prev, items: newItems })); };
    const removePageItem = (index) => { const newItems = (pageEditData.items || []).filter((_, i) => i !== index); setPageEditData(prev => ({ ...prev, items: newItems })); };
    const insertSnippet = (template) => setPageEditData(prev => ({ ...prev, htmlContent: (prev.htmlContent || '') + '\n' + template }));
    
    // TOC Logic
    const addTocEntry = () => setConfig(prev => ({ ...prev, tableOfContent: [...prev.tableOfContent, { title: "New Chapter", page: "1" }] }));
    const updateTocEntry = (index, key, value) => { const newToc = [...config.tableOfContent]; newToc[index] = { ...newToc[index], [key]: value }; setConfig(prev => ({ ...prev, tableOfContent: newToc })); };
    const removeTocEntry = (index) => setConfig(prev => ({ ...prev, tableOfContent: config.tableOfContent.filter((_, i) => i !== index) }));

    const copyToClipboard = () => {
        const code = generateFullHTML();
        navigator.clipboard.writeText(code).then(() => {
          setShowCopyFeedback(true);
          setTimeout(() => setShowCopyFeedback(false), 2000);
        });
    };

    // --- DIFF ENGINE FOR SMART CODE GENERATION ---
    const getEffectiveDefaults = (layout) => {
        // Base defaults are Layout 1 effectively
        const base = JSON.parse(JSON.stringify(defaultOptions));
        // Apply preset overrides if any (e.g. Layout 2, 3, 4)
        if (LAYOUT_PRESETS[layout]) {
            return mergeObjects(base, LAYOUT_PRESETS[layout]);
        }
        return base;
    };

    const diffObjects = (current, defaults) => {
        const diff = {};
        let hasChanges = false;

        Object.keys(current).forEach(key => {
            const val = current[key];
            const def = defaults[key];

            // Ignore internal props or props that don't matter for output if null/empty
            if (key === 'mobile' && (!val || Object.keys(val).length === 0)) return;

            if (JSON.stringify(val) !== JSON.stringify(def)) {
                if (typeof val === 'object' && val !== null && !Array.isArray(val)) {
                    const nestedDiff = diffObjects(val, def || {});
                    if (Object.keys(nestedDiff).length > 0) {
                        diff[key] = nestedDiff;
                        hasChanges = true;
                    }
                } else {
                    diff[key] = val;
                    hasChanges = true;
                }
            }
        });
        return diff;
    };

    const generateFullHTML = () => {
        const indent = framework === 'vanilla' ? '    ' : '        ';
        
        // 1. Get Effective Defaults for the selected layout
        const effectiveDefaults = getEffectiveDefaults(config.layout);
        
        // 2. Calculate Diff
        let finalConfig = diffObjects(config, effectiveDefaults);
        
        // 3. Ensure required fields are present even if they match default
        finalConfig.pdfUrl = config.pdfUrl; // Always include PDF URL
        if (config.layout && config.layout !== "1") finalConfig.layout = config.layout; // Include layout if not 1
        // Note: If layout is 1, it's default, so we can omit it or keep it. Let's keep it if user explicitly set it in UI, but diff removes it if it matches defaultOptions.layout.
        // Actually, for clarity, let's inject layout if it exists in config, unless it is "1" and matches defaultOptions.
        
        if (licenseKey) finalConfig.s = licenseKey;

        let jsonString = JSON.stringify(finalConfig, null, 4);
        jsonString = jsonString.replace(/"([^"]+)":/g, '$1:'); 
        const lines = jsonString.split('\n');
        const indentedLines = lines.map(line => indent + line);
        
        if (licenseKey) {
            const index = indentedLines.findIndex(line => line.includes('s:'));
            if (index !== -1) indentedLines.splice(index, 0, `${indent}// ⬇️ PASTE YOUR LICENSE KEY HERE ⬇️`);
        }

        const opts = indentedLines.join('\n');
        const script = framework === 'vanilla' 
        ? `    var container = document.getElementById("book-container");\n    var book = new FlipBook(container, ${opts.trim()});`
        : `    jQuery(document).ready(function () {\n        $("#book-container").flipBook(${opts.trim()});\n    });`;

        return `<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real3D FlipBook</title>
    <link rel="stylesheet" type="text/css" href="css/flipbook.style.css">
    <script src="js/flipbook.min.js"></script>
    ${framework === 'jquery' ? '<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>' : ''}
</head>
<body>
    <div id="book-container" style="height: 100vh; width: 100%;"></div>
    <script type="text/javascript">
${script}
    </script>
</body>
</html>`;
    };
    
    // Props for wrapper to reduce redundancy
    const p = (key, label, type='text', options=[]) => ({
        label, 
        helpKey: key, 
        isMobile: editScope === 'mobile', 
        hasOverride: hasMobileOverride(key),
        value: getValue(key),
        onChange: (v) => update(key, v),
        options
    });

    return (
        <div className="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans flex flex-col h-screen">
            <header className="bg-white dark:bg-slate-800 shadow-sm border-b border-slate-200 dark:border-slate-700 flex-none z-10">
                <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="bg-blue-600 p-2 rounded-lg">
                            <FileText className="text-white h-5 w-5" />
                        </div>
                        <h1 className="text-xl font-bold tracking-tight">Real3D FlipBook <span className="text-blue-600">Generator</span></h1>
                    </div>
                    
                    <div className="flex items-center gap-4">
                        {/* EDIT SCOPE TOGGLE */}
                        <div className="bg-slate-100 dark:bg-slate-700 p-1 rounded-lg flex gap-1">
                            <button onClick={() => setEditScope('global')} className={`flex items-center gap-2 px-3 py-1.5 text-xs font-bold rounded-md transition-all ${editScope==='global' ? 'bg-white shadow text-slate-800 dark:bg-slate-600 dark:text-white' : 'text-slate-500 hover:text-slate-700'}`}>
                                <Monitor size={14} /> Desktop (Global)
                            </button>
                            <button onClick={() => setEditScope('mobile')} className={`flex items-center gap-2 px-3 py-1.5 text-xs font-bold rounded-md transition-all ${editScope==='mobile' ? 'bg-purple-600 shadow text-white' : 'text-slate-500 hover:text-slate-700'}`}>
                                <Smartphone size={14} /> Mobile Override
                            </button>
                        </div>

                        <div className="h-6 w-px bg-slate-200 dark:bg-slate-600 mx-2"></div>

                        <div className="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                            <button onClick={() => setFramework('vanilla')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all ${framework === 'vanilla' ? 'bg-white dark:bg-slate-600 text-blue-600 shadow-sm' : 'text-slate-500'}`}>Vanilla JS</button>
                            <button onClick={() => setFramework('jquery')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all ${framework === 'jquery' ? 'bg-white dark:bg-slate-600 text-blue-600 shadow-sm' : 'text-slate-500'}`}>jQuery</button>
                        </div>
                    </div>
                </div>
            </header>

            <main className="flex-1 overflow-hidden flex max-w-7xl mx-auto w-full relative">
                {editScope === 'mobile' && (
                    <div className="absolute top-0 left-0 w-1/2 h-full border-4 border-purple-500 pointer-events-none z-0 opacity-10"></div>
                )}
                
                <div className="w-1/2 flex flex-col border-r border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 z-10">
                    <div className="flex overflow-x-auto border-b border-slate-200 dark:border-slate-700 scrollbar-hide">
                        <TabButton active={activeTab === 'source'} onClick={() => setActiveTab('source')} label="Source" icon={Database} />
                        <TabButton active={activeTab === 'layout'} onClick={() => setActiveTab('layout')} label="Appearance" icon={Layout} />
                        <TabButton active={activeTab === 'ui'} onClick={() => setActiveTab('ui')} label="Menus & UI" icon={Palette} />
                        <TabButton active={activeTab === 'toolbar'} onClick={() => setActiveTab('toolbar')} label="Toolbar" icon={MousePointer} />
                        <TabButton active={activeTab === 'behavior'} onClick={() => setActiveTab('behavior')} label="Behavior" icon={Zap} />
                        <TabButton active={activeTab === 'webgl'} onClick={() => setActiveTab('webgl')} label="WebGL" icon={Box} />
                        <TabButton active={activeTab === 'advanced'} onClick={() => setActiveTab('advanced')} label="Advanced" icon={Settings} />
                        <TabButton active={activeTab === 'i18n'} onClick={() => setActiveTab('i18n')} label="Localization" icon={Globe} />
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                         {editScope === 'mobile' && (
                            <div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 p-3 rounded-md mb-6 flex items-start gap-3">
                                <Smartphone className="text-purple-600 mt-1" size={20} />
                                <div>
                                    <h4 className="text-sm font-bold text-purple-700 dark:text-purple-300">Editing Mobile Overrides</h4>
                                    <p className="text-xs text-purple-600 dark:text-purple-400 mt-1">Changes made here will only apply to mobile devices. If a field says "Inherited", it uses the Desktop value.</p>
                                </div>
                            </div>
                        )}

                        {activeTab === 'source' && (
                            <Section title="Content Source" icon={Database}>
                                <TextInput {...p('pdfUrl', 'PDF URL', 'text')} placeholder="books/book.pdf" />
                                <TextInput {...p('licenseKey', 'License Key')} placeholder="Paste key..." />
                                <TextInput {...p('name', 'Project Name')} />
                                
                                <Toggle label="Auto-detect PDF Links" checked={getValue('pdfAutoLinks')} onChange={(v) => update('pdfAutoLinks', v)} helpKey="pdfAutoLinks" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('pdfAutoLinks')} />
                                
                                {editScope === 'global' && (
                                    <>
                                        <div className="mt-6 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700">
                                            <div className="flex items-center justify-between mb-2">
                                                <h4 className="text-sm font-bold text-slate-700 dark:text-slate-300">Pages ({config.pages.length})</h4>
                                                <button onClick={() => setShowPageManager(true)} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition-colors flex items-center gap-1">
                                                    <Edit2 size={12} /> Manage Pages
                                                </button>
                                            </div>
                                            <p className="text-xs text-slate-500">Add pages, HTML content, videos, and links.</p>
                                        </div>

                                        <div className="mt-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700">
                                            <div className="flex items-center justify-between mb-2">
                                                <h4 className="text-sm font-bold text-slate-700 dark:text-slate-300">Table of Contents ({config.tableOfContent.length})</h4>
                                                <button onClick={() => setShowTocManager(true)} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition-colors flex items-center gap-1">
                                                    <List size={12} /> Manage TOC
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                )}
                                
                                <JsonInput label="Assets (Sounds/Images)" value={getValue('assets')} onChange={(v) => update('assets', v)} helpKey="assets" isMobile={editScope==='mobile'} />
                                
                                <div className="mt-4 border-t pt-4">
                                    <h4 className="text-xs font-bold uppercase text-slate-500 mb-2">Loading Strategy</h4>
                                    <Toggle label="Load All Pages" checked={getValue('loadAllPages')} onChange={(v) => update('loadAllPages', v)} helpKey="loadAllPages" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('loadAllPages')} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <NumberInput {...p('loadPagesF', 'Load Forward')} helpKey="loadPagesF" />
                                        <NumberInput {...p('loadPagesB', 'Keep Backward')} helpKey="loadPagesB" />
                                    </div>
                                </div>
                            </Section>
                        )}

                        {activeTab === 'layout' && (
                            <div className="space-y-4">
                                <Section title="View Settings" icon={Eye}>
                                    <SelectInput {...p('viewMode', 'View Mode', 'text', [{value:'webgl',label:'WebGL 3D'},{value:'3d',label:'CSS 3D'},{value:'2d',label:'2D'},{value:'swipe',label:'Swipe'},{value:'simple',label:'Simple'}])} />
                                    <SelectInput {...p('skin', 'Skin', 'text', [{value:'light',label:'Light'},{value:'dark',label:'Dark'},{value:'gradient',label:'Gradient'}])} />
                                    <SelectInput {...p('layout', 'UI Layout', 'text', [{value:'1',label:'Layout 1'},{value:'2',label:'Layout 2'},{value:'3',label:'Layout 3'},{value:'4',label:'Layout 4'}])} />
                                    
                                    <Toggle label="Right to Left" checked={getValue('rightToLeft')} onChange={(v) => update('rightToLeft', v)} helpKey="rightToLeft" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('rightToLeft')} />
                                    <Toggle label="Responsive View" checked={getValue('responsiveView')} onChange={(v) => update('responsiveView', v)} helpKey="responsiveView" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('responsiveView')} />
                                    
                                    <TextInput {...p('backgroundColor', 'Background Color')} />
                                    <TextInput {...p('backgroundImage', 'Background Image URL')} />
                                    <TextInput {...p('backgroundPattern', 'Background Pattern URL')} />
                                    <Toggle label="Transparent Background" checked={getValue('backgroundTransparent')} onChange={(v) => update('backgroundTransparent', v)} helpKey="backgroundTransparent" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('backgroundTransparent')} />
                                    <TextInput {...p('skinColor', 'Skin Color (Primary)')} helpKey="skinColor" />
                                    <TextInput {...p('skinBackground', 'Skin Background (Secondary)')} helpKey="skinBackground" />
                                </Section>
                                <Section title="Branding" icon={Zap}>
                                    <TextInput {...p('logoImg', 'Logo Image URL')} />
                                    <TextInput {...p('logoUrl', 'Logo Click URL')} />
                                    <TextInput {...p('logoCSS', 'Logo CSS Position')} />
                                    <TextInput {...p('preloaderText', 'Preloader Text')} />
                                </Section>
                            </div>
                        )}

                        {activeTab === 'ui' && (
                             <div className="space-y-6">
                                <Section title="Bottom Menu (Main)" icon={Layout}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Toggle label="Transparent" checked={getValue('menuTransparent')} onChange={(v) => update('menuTransparent', v)} helpKey="menuTransparent" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('menuTransparent')} />
                                        <Toggle label="Over Book" checked={getValue('menuOverBook')} onChange={(v) => update('menuOverBook', v)} helpKey="menuOverBook" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('menuOverBook')} />
                                        <Toggle label="Floating" checked={getValue('menuFloating')} onChange={(v) => update('menuFloating', v)} helpKey="menuFloating" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('menuFloating')} />
                                        <NumberInput {...p('menuMargin', 'Margin')} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 mt-2">
                                        <TextInput {...p('menuBackground', 'Background CSS')} />
                                        <TextInput {...p('menuShadow', 'Shadow CSS')} />
                                        <NumberInput {...p('menuPadding', 'Menu Padding')} />
                                    </div>
                                </Section>

                                <Section title="Top Menu (Secondary)" icon={Layout}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Toggle label="Transparent" checked={getValue('menu2Transparent')} onChange={(v) => update('menu2Transparent', v)} helpKey="menu2Transparent" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('menu2Transparent')} />
                                        <Toggle label="Over Book" checked={getValue('menu2OverBook')} onChange={(v) => update('menu2OverBook', v)} isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('menu2OverBook')} />
                                        <Toggle label="Floating" checked={getValue('menu2Floating')} onChange={(v) => update('menu2Floating', v)} isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('menu2Floating')} />
                                        <NumberInput {...p('menu2Margin', 'Margin')} />
                                        <NumberInput {...p('menu2Padding', 'Menu2 Padding')} />
                                    </div>
                                </Section>
                                
                                <Section title="Side Menu" icon={Layout}>
                                    <div className="grid grid-cols-2 gap-4">
                                         <SelectInput {...p('sideMenuPosition', 'Position', 'text', [{value:'left',label:'Left'},{value:'right',label:'Right'}])} />
                                         <Toggle label="Over Book" checked={getValue('sideMenuOverBook')} onChange={(v) => update('sideMenuOverBook', v)} isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('sideMenuOverBook')} />
                                    </div>
                                </Section>

                                <Section title="Buttons Styling" icon={Palette}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <TextInput {...p('btnColor', 'Icon Color')} />
                                        <TextInput {...p('btnBackground', 'Background')} />
                                        <NumberInput {...p('btnSize', 'Icon Size')} />
                                        <NumberInput {...p('btnRadius', 'Radius')} />
                                        <NumberInput {...p('btnMargin', 'Margin')} />
                                    </div>
                                </Section>

                                <Section title="Side Navigation Arrows" icon={MousePointer}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <TextInput {...p('sideBtnColor', 'Color')} />
                                        <TextInput {...p('sideBtnBackground', 'Background')} />
                                        <NumberInput {...p('sideBtnSize', 'Size')} />
                                        <NumberInput {...p('sideBtnPaddingV', 'Padding V')} />
                                    </div>
                                </Section>
                            </div>
                        )}

                        {activeTab === 'toolbar' && (
                             <div className="space-y-6">
                                <Section title="Button Visibility" icon={CheckSquare}>
                                    <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                                        {Object.keys(config).filter(k => k.startsWith('btn') && typeof config[k] === 'object' && config[k].hasOwnProperty('enabled')).map(key => {
                                            const currentVal = editScope === 'mobile' 
                                                ? (config.mobile && config.mobile[key] ? config.mobile[key].enabled : config[key].enabled)
                                                : config[key].enabled;
                                            const hasOver = editScope === 'mobile' && config.mobile && config.mobile[key] && config.mobile[key].enabled !== undefined;
                                            return (
                                                <Toggle 
                                                    key={key} 
                                                    label={key.replace('btn', '')} 
                                                    checked={currentVal} 
                                                    onChange={() => toggleButton(key)} 
                                                    helpKey={key} 
                                                    isMobile={editScope==='mobile'}
                                                    hasOverride={hasOver}
                                                />
                                            );
                                        })}
                                    </div>
                                </Section>
                                
                                <Section title="Button Order" icon={List}>
                                    <JsonInput label="Toolbar Button Order (Array)" value={getValue('btnOrder')} onChange={(v) => update('btnOrder', v)} helpKey="btnOrder" isMobile={editScope==='mobile'} />
                                </Section>

                                <Section title="Individual Button Customizer" icon={Sliders}>
                                    <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                                        <SelectInput 
                                            label="Select Button to Edit" 
                                            value={selectedBtn} 
                                            onChange={setSelectedBtn} 
                                            options={Object.keys(config).filter(k => (k.startsWith('btn') || k==='currentPage') && typeof config[k] === 'object' && config[k].hasOwnProperty('enabled')).map(k => ({value: k, label: k}))} 
                                            helpKey={selectedBtn}
                                            isMobile={editScope==='mobile'}
                                            hasOverride={false}
                                        />
                                        <div className="mt-4 grid grid-cols-2 gap-4 border-t border-slate-200 dark:border-slate-700 pt-4">
                                            {/* For simplicity, we are editing props directly on the current scope's button object */}
                                            {/* Note: In a full app, we'd wrap these inputs too with inherit logic visualization */}
                                            <TextInput label="Title (Hover)" value={getValue(selectedBtn).title} onChange={(v) => updateButtonProp(selectedBtn, 'title', v)} isMobile={editScope==='mobile'} />
                                            <TextInput label="Icon (FontAwesome)" value={getValue(selectedBtn).iconFA} onChange={(v) => updateButtonProp(selectedBtn, 'iconFA', v)} isMobile={editScope==='mobile'} />
                                            <TextInput label="Icon (Material)" value={getValue(selectedBtn).iconM} onChange={(v) => updateButtonProp(selectedBtn, 'iconM', v)} isMobile={editScope==='mobile'} />
                                            <SelectInput label="H-Align" value={getValue(selectedBtn).hAlign} onChange={(v) => updateButtonProp(selectedBtn, 'hAlign', v)} options={[{value:'left',label:'Left'},{value:'right',label:'Right'},{value:'center',label:'Center'}]} isMobile={editScope==='mobile'} />
                                            <SelectInput label="V-Align" value={getValue(selectedBtn).vAlign} onChange={(v) => updateButtonProp(selectedBtn, 'vAlign', v)} options={[{value:'top',label:'Top'},{value:'bottom',label:'Bottom'}]} isMobile={editScope==='mobile'} />
                                            
                                            {selectedBtn === 'btnDownloadPages' && (
                                                <div className="col-span-2 mt-2 border-t pt-2">
                                                    <TextInput label="Download URL" value={getValue(selectedBtn).url} onChange={(v) => updateButtonProp(selectedBtn, 'url', v)} helpKey="btnDownloadPagesUrl" />
                                                </div>
                                            )}
                                            {selectedBtn === 'btnDownloadPdf' && (
                                                <div className="col-span-2 mt-2 border-t pt-2">
                                                    <TextInput label="PDF Download URL" value={getValue(selectedBtn).url} onChange={(v) => updateButtonProp(selectedBtn, 'url', v)} helpKey="btnDownloadPdfUrl" />
                                                    <Toggle label="Open New Window" checked={getValue(selectedBtn).openInNewWindow} onChange={(v) => updateButtonProp(selectedBtn, 'openInNewWindow', v)} helpKey="btnDownloadPdfOpenInNewWindow" />
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </Section>
                                <Section title="Social Sharing" icon={Share2}>
                                    <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                                        {['whatsapp','twitter','facebook','pinterest','email','linkedin','digg','reddit'].map(key => {
                                             const currentVal = editScope === 'mobile' 
                                                ? (config.mobile && config.mobile[key] ? config.mobile[key].enabled : config[key].enabled)
                                                : config[key].enabled;
                                            const hasOver = editScope === 'mobile' && config.mobile && config.mobile[key] && config.mobile[key].enabled !== undefined;
                                            return <Toggle key={key} label={key.charAt(0).toUpperCase() + key.slice(1)} checked={currentVal} onChange={() => toggleSocial(key)} isMobile={editScope==='mobile'} hasOverride={hasOver} />
                                        })}
                                    </div>
                                </Section>
                             </div>
                        )}

                        {activeTab === 'behavior' && (
                            <div className="space-y-4">
                                <Section title="Interaction" icon={MousePointer}>
                                    <Toggle label="Touch Swipe" checked={getValue('touchSwipeEnabled')} onChange={(v) => update('touchSwipeEnabled', v)} helpKey="touchSwipeEnabled" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('touchSwipeEnabled')} />
                                    <Toggle label="Right Click" checked={getValue('rightClickEnabled')} onChange={(v) => update('rightClickEnabled', v)} helpKey="rightClickEnabled" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('rightClickEnabled')} />
                                    <Toggle label="Deep Linking" checked={getValue('deeplinkingEnabled')} onChange={(v) => update('deeplinkingEnabled', v)} helpKey="deeplinkingEnabled" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('deeplinkingEnabled')} />
                                    <Toggle label="Page Drag Disabled" checked={getValue('pageDragDisabled')} onChange={(v) => update('pageDragDisabled', v)} helpKey="pageDragDisabled" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('pageDragDisabled')} />
                                    <TextInput {...p('pageClickAreaWdith', 'Click Area Width')} />
                                    <Toggle label="Disable Wheel (Unless Fullscreen)" checked={getValue('wheelDisabledNotFullscreen')} onChange={(v) => update('wheelDisabledNotFullscreen', v)} helpKey="wheelDisabledNotFullscreen" />
                                    <Toggle label="Disable Arrows (Unless Fullscreen)" checked={getValue('arrowsDisabledNotFullscreen')} onChange={(v) => update('arrowsDisabledNotFullscreen', v)} helpKey="arrowsDisabledNotFullscreen" />
                                </Section>
                                <Section title="On Start Actions" icon={Zap}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Toggle label="Open TOC" checked={getValue('contentOnStart')} onChange={(v) => update('contentOnStart', v)} helpKey="contentOnStart" />
                                        <Toggle label="Open Thumbs" checked={getValue('thumbnailsOnStart')} onChange={(v) => update('thumbnailsOnStart', v)} helpKey="thumbnailsOnStart" />
                                        <Toggle label="Open Search" checked={getValue('searchOnStart')} onChange={(v) => update('searchOnStart', v)} helpKey="searchOnStart" />
                                    </div>
                                </Section>
                                <Section title="Zoom & Pan" icon={ImageIcon}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <NumberInput {...p('zoomStep', 'Zoom Step')} />
                                        <NumberInput {...p('zoomTime', 'Zoom Time')} />
                                        <NumberInput {...p('zoomMax2', 'Max Zoom (Level 2)')} />
                                        <Toggle label="Reset Zoom on Page" checked={getValue('zoomReset')} onChange={(v) => update('zoomReset', v)} helpKey="zoomReset" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('zoomReset')} />
                                    </div>
                                </Section>
                                <Section title="Audio & Auto" icon={Volume2}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Toggle label="Flip Sound" checked={getValue('flipSound')} onChange={(v) => update('flipSound', v)} helpKey="flipSound" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('flipSound')} />
                                        <Toggle label="Autoplay" checked={getValue('autoplayOnStart')} onChange={(v) => update('autoplayOnStart', v)} helpKey="autoplayOnStart" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('autoplayOnStart')} />
                                    </div>
                                    <TextInput {...p('backgroundMusic', 'Background Music URL (MP3)')} helpKey="backgroundMusic" />
                                </Section>
                            </div>
                        )}

                        {activeTab === 'webgl' && (
                            <div className="space-y-4">
                                <Section title="Camera Limits" icon={Box}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <NumberInput {...p('panMax', 'Pan Max')} />
                                        <NumberInput {...p('tiltMax', 'Tilt Max')} />
                                    </div>
                                </Section>
                                <Section title="Physics & Material" icon={Layers}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <NumberInput {...p('pageHardness', 'Page Hardness')} />
                                        <NumberInput {...p('pageRoughness', 'Roughness')} />
                                        <NumberInput {...p('pageTextureSize', 'Texture Size (px)')} />
                                        <NumberInput {...p('pageTextureSizeSmall', 'Small Texture Size (px)')} />
                                        <NumberInput {...p('thumbTextureSize', 'Thumb Texture Size (px)')} />
                                    </div>
                                    <div className="mt-2">
                                        <Toggle label="Disable Image Resize (Pow2)" checked={getValue('disableImageResize')} onChange={(v) => update('disableImageResize', v)} helpKey="disableImageResize" />
                                        <Toggle label="Antialias" checked={getValue('antialias')} onChange={(v) => update('antialias', v)} helpKey="antialias" />
                                    </div>
                                </Section>
                                <Section title="Lighting & Shadows" icon={Zap}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Toggle label="Lights" checked={getValue('lights')} onChange={(v) => update('lights', v)} helpKey="lights" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('lights')} />
                                        <Toggle label="Shadows" checked={getValue('shadows')} onChange={(v) => update('shadows', v)} helpKey="webglShadows" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('shadows')} />
                                        <NumberInput {...p('lightIntensity', 'Light Intensity', 'number', [], 0.1)} />
                                        <NumberInput {...p('shadowOpacity', 'Shadow Opacity', 'number', [], 0.1)} />
                                    </div>
                                </Section>
                            </div>
                        )}

                        {activeTab === 'advanced' && (
                             <div className="space-y-4">
                                <Section title="Lightbox" icon={Layers}>
                                    <Toggle label="Enable Lightbox" checked={getValue('lightBox')} onChange={(v) => update('lightBox', v)} helpKey="lightBox" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('lightBox')} />
                                    <Toggle label="Close On Click" checked={getValue('lightboxCloseOnClick')} onChange={(v) => update('lightboxCloseOnClick', v)} helpKey="lightboxCloseOnClick" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('lightboxCloseOnClick')} />
                                    <TextInput {...p('lightboxBackground', 'Background CSS')} />
                                </Section>
                                <Section title="System" icon={Settings}>
                                    <NumberInput {...p('rangeChunkSize', 'Chunk Size (KB)')} />
                                    <Toggle label="Disable Streaming" checked={getValue('disableStream')} onChange={(v) => update('disableStream', v)} helpKey="disableStream" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('disableStream')} />
                                    <Toggle label="Disable Auto-Fetch" checked={getValue('disableAutoFetch')} onChange={(v) => update('disableAutoFetch', v)} helpKey="disableAutoFetch" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('disableAutoFetch')} />
                                    <Toggle label="Disable Range Requests" checked={getValue('disableRange')} onChange={(v) => update('disableRange', v)} helpKey="disableRange" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('disableRange')} />
                                    <Toggle label="Native PDF on Mobile" checked={getValue('pdfBrowserViewerIfMobile')} onChange={(v) => update('pdfBrowserViewerIfMobile', v)} helpKey="pdfBrowserViewerIfMobile" isMobile={editScope==='mobile'} hasOverride={hasMobileOverride('pdfBrowserViewerIfMobile')} />
                                    <Toggle label="Use Native PDF in IE" checked={getValue('pdfBrowserViewerIfIE')} onChange={(v) => update('pdfBrowserViewerIfIE', v)} />
                                    <TextInput {...p('pdfBrowserViewerFullscreenTarget', 'Native Viewer Target')} />
                                    <TextInput {...p('googleAnalyticsTrackingCode', 'GA Tracking ID')} />
                                    <NumberInput {...p('minPixelRatio', 'Min Pixel Ratio')} />
                                    <NumberInput {...p('minimumAndroidVersion', 'Min Android Version')} />
                                </Section>
                                <Section title="Link Settings" icon={LinkIcon}>
                                    <TextInput {...p('linkColor', 'Link Color')} />
                                    <TextInput {...p('linkColorHover', 'Link Hover Color')} />
                                </Section>
                                <Section title="Annotations" icon={Edit2}>
                                    <JsonInput label="Note Types (JSON)" value={getValue('noteTypes')} onChange={(v) => update('noteTypes', v)} helpKey="noteTypes" isMobile={editScope==='mobile'} />
                                </Section>
                                <Section title="Page Range" icon={List}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <NumberInput {...p('pageRangeStart', 'Start Page Index')} helpKey="pageRangeStart" />
                                        <NumberInput {...p('pageRangeEnd', 'End Page Index')} helpKey="pageRangeEnd" />
                                    </div>
                                </Section>
                            </div>
                        )}
                        
                        {activeTab === 'i18n' && (
                            <Section title="Localization Strings" icon={Globe}>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {Object.keys(config.strings).map(key => (
                                        <div key={key}>
                                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">{key}</label>
                                            <input 
                                                type="text" 
                                                className="block w-full rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                                value={config.strings[key]} 
                                                onChange={(e) => updateString(key, e.target.value)} 
                                            />
                                        </div>
                                    ))}
                                </div>
                            </Section>
                        )}
                    </div>
                </div>

                <div className="w-1/2 bg-slate-900 text-slate-300 flex flex-col z-10">
                    <div className="flex items-center justify-between px-4 py-3 bg-slate-950 border-b border-slate-800">
                        <span className="text-xs font-mono text-slate-400">index.html</span>
                        <button onClick={copyToClipboard} className="flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-500 text-white text-xs font-medium transition-colors">
                            {showCopyFeedback ? <CheckSquare size={14} /> : <Copy size={14} />}
                            {showCopyFeedback ? 'Copied!' : 'Copy Code'}
                        </button>
                    </div>
                    <div className="flex-1 overflow-auto p-4 custom-scrollbar">
                         <pre className="text-xs font-mono leading-relaxed">
                            {generateFullHTML()}
                        </pre>
                    </div>
                </div>

            </main>

            {/* PAGE MANAGER MODAL */}
            <Modal isOpen={showPageManager} onClose={() => {setShowPageManager(false); setEditingPage(null);}} title="Page Manager">
                {!editingPage && editingPage !== 0 ? (
                    <div className="space-y-4">
                        <div className="flex justify-end">
                            <button onClick={addNewPage} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                                <Plus size={16} /> Add Page
                            </button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {config.pages.map((page, idx) => (
                                <div key={idx} className="border border-slate-200 dark:border-slate-700 rounded-lg p-3 bg-slate-50 dark:bg-slate-900 relative group">
                                    <div className="h-32 bg-slate-200 dark:bg-slate-800 rounded mb-2 flex items-center justify-center text-slate-400 overflow-hidden">
                                        {page.thumb || page.src ? (
                                            <img src={page.thumb || page.src} alt="" className="w-full h-full object-cover" />
                                        ) : <ImageIcon size={32} />}
                                    </div>
                                    <h4 className="font-bold text-sm truncate">{page.title || `Page ${idx+1}`}</h4>
                                    <p className="text-xs text-slate-500 truncate">{page.src || "No source"}</p>
                                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={() => openEditPage(idx)} className="p-1.5 bg-blue-500 text-white rounded"><Edit2 size={12}/></button>
                                        <button onClick={() => deletePage(idx)} className="p-1.5 bg-red-500 text-white rounded"><Trash2 size={12}/></button>
                                    </div>
                                </div>
                            ))}
                            {config.pages.length === 0 && <div className="col-span-full text-center py-10 text-slate-400">No pages added yet.</div>}
                        </div>
                    </div>
                ) : (
                    <div className="space-y-6">
                        <button onClick={() => setEditingPage(null)} className="text-sm text-blue-500 hover:underline mb-4">← Back to Page List</button>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <TextInput label="Image Source" value={pageEditData.src} onChange={(v) => updatePageData('src', v)} placeholder="books/page1.jpg" />
                            <TextInput label="Thumbnail" value={pageEditData.thumb} onChange={(v) => updatePageData('thumb', v)} placeholder="books/thumb1.jpg" />
                            <TextInput label="Page Title" value={pageEditData.title} onChange={(v) => updatePageData('title', v)} placeholder="Chapter 1" />
                            <TextInput label="JSON Data File (Optimized PDF)" value={pageEditData.json} onChange={(v) => updatePageData('json', v)} placeholder="books/page1.json" />
                        </div>

                        <Section title="HTML Content (Overlay)" icon={Code}>
                            <p className="text-xs text-slate-500 mb-2">Add HTML to be overlayed on this page. Use the templates below for quick insertion.</p>
                            <div className="flex gap-2 mb-2 flex-wrap">
                                <button onClick={() => insertSnippet(`<video class="flipbook-page-item" playsinline loop autoplay muted style="top:100px;left:40px;width:230px;height:128px;"><source type="video/mp4" src="your_video.mp4"></video>`)} className="text-xs flex items-center gap-1 bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded hover:bg-slate-300"><Film size={12}/> Video</button>
                                <button onClick={() => insertSnippet(`<iframe class="flipbook-page-item" src="https://www.youtube.com/embed/VIDEO_ID" style="top:100px;left:40px;width:226px;height:126px;" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`)} className="text-xs flex items-center gap-1 bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded hover:bg-slate-300"><Youtube size={12}/> YouTube</button>
                                <button onClick={() => insertSnippet(`<a class="flipbook-page-item flipbook-page-item-link" href="https://example.com" target="_blank" style="width: 200px; height: 50px; position: absolute; top: 200px; left: 50px;"></a>`)} className="text-xs flex items-center gap-1 bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded hover:bg-slate-300"><LinkIcon size={12}/> Link</button>
                            </div>
                            <textarea 
                                className="w-full h-32 bg-slate-50 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-md p-2 text-xs font-mono"
                                value={pageEditData.htmlContent || ''}
                                onChange={(e) => updatePageData('htmlContent', e.target.value)}
                                placeholder="<div>HTML content here...</div>"
                            />
                        </Section>

                        <Section title="Page Items (Interactive)" icon={Layers}>
                             <div className="space-y-3">
                                {(pageEditData.items || []).map((item, idx) => (
                                    <div key={idx} className="flex flex-wrap items-end gap-2 p-3 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-900 relative">
                                        <div className="w-24"><label className="text-[10px] uppercase font-bold text-slate-500">Type</label>
                                            <select className="w-full text-xs p-1 rounded border dark:bg-slate-800" value={item.type} onChange={(e) => updatePageItem(idx, 'type', e.target.value)}>
                                                <option value="video">Video</option><option value="youtube">YouTube</option><option value="link">Link</option><option value="iframe">Iframe</option><option value="image">Image</option><option value="audio">Audio</option>
                                            </select>
                                        </div>
                                        <div className="w-16"><label className="text-[10px] uppercase font-bold text-slate-500">X</label><input type="number" className="w-full text-xs p-1 rounded border dark:bg-slate-800" value={item.x} onChange={(e) => updatePageItem(idx, 'x', Number(e.target.value))} /></div>
                                        <div className="w-16"><label className="text-[10px] uppercase font-bold text-slate-500">Y</label><input type="number" className="w-full text-xs p-1 rounded border dark:bg-slate-800" value={item.y} onChange={(e) => updatePageItem(idx, 'y', Number(e.target.value))} /></div>
                                        <div className="w-16"><label className="text-[10px] uppercase font-bold text-slate-500">W</label><input type="number" className="w-full text-xs p-1 rounded border dark:bg-slate-800" value={item.width} onChange={(e) => updatePageItem(idx, 'width', Number(e.target.value))} /></div>
                                        <div className="w-16"><label className="text-[10px] uppercase font-bold text-slate-500">H</label><input type="number" className="w-full text-xs p-1 rounded border dark:bg-slate-800" value={item.height} onChange={(e) => updatePageItem(idx, 'height', Number(e.target.value))} /></div>
                                        <div className="flex-1"><label className="text-[10px] uppercase font-bold text-slate-500">URL / Content</label><input type="text" className="w-full text-xs p-1 rounded border dark:bg-slate-800" value={item.url || ''} onChange={(e) => updatePageItem(idx, 'url', e.target.value)} placeholder="https://..." /></div>
                                        <button onClick={() => removePageItem(idx)} className="p-1 text-red-500 hover:bg-red-50 rounded"><Trash2 size={14}/></button>
                                    </div>
                                ))}
                                <button onClick={addPageItem} className="text-xs flex items-center gap-1 text-blue-600 hover:underline"><Plus size={14}/> Add New Item</button>
                             </div>
                        </Section>

                        <div className="flex justify-end pt-4 border-t border-slate-200 dark:border-slate-700">
                            <button onClick={savePageEdit} className="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 font-bold">Save Changes</button>
                        </div>
                    </div>
                )}
            </Modal>

            {/* TOC MANAGER MODAL */}
            <Modal isOpen={showTocManager} onClose={() => setShowTocManager(false)} title="Table of Contents">
                <div className="space-y-4">
                     {config.tableOfContent.map((entry, idx) => (
                        <div key={idx} className="flex gap-4 items-center">
                            <div className="flex-1">
                                <label className="text-[10px] uppercase font-bold text-slate-500">Title</label>
                                <input type="text" className="w-full p-2 text-sm border rounded dark:bg-slate-800 dark:border-slate-600" value={entry.title} onChange={(e) => updateTocEntry(idx, 'title', e.target.value)} />
                            </div>
                            <div className="w-24">
                                <label className="text-[10px] uppercase font-bold text-slate-500">Page #</label>
                                <input type="text" className="w-full p-2 text-sm border rounded dark:bg-slate-800 dark:border-slate-600" value={entry.page} onChange={(e) => updateTocEntry(idx, 'page', e.target.value)} />
                            </div>
                            <button onClick={() => removeTocEntry(idx)} className="mt-5 p-2 text-red-500 hover:bg-slate-100 rounded"><Trash2 size={16}/></button>
                        </div>
                     ))}
                     <button onClick={addTocEntry} className="flex items-center gap-2 text-blue-600 text-sm font-bold mt-4"><Plus size={16}/> Add Chapter</button>
                </div>
            </Modal>

        </div>
    );
};

export default FlipBookGenerator;
